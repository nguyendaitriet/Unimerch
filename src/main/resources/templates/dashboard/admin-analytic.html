<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <th:block th:replace="layout/head :: dashboard-head"/>
    <title th:text="#{analyse.pageTitle}">Users Management</title>
</head>
<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <!-- Sidebar -->
    <th:block th:replace="layout/sidebar :: sidebar"/>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">

            <!-- Begin Page Content -->
            <div class="container-fluid mt-3">
                <div class="row">

                    <!-- Users -->
                    <div class="col">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <a class="m-0 h4 font-weight-bold text-primary text-decoration-none"
                                   th:text="#{analyse.tabHeader}">
                                </a>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body">
                                <div class="row">
                                    <select class="selectpicker" id="analGrpSelect" data-live-search="true">
                                        <option value="0" th:text="#{analyse.allGroupsSelect}">All Groups</option>
                                    </select>
                                    <select class="selectpicker ml-3" id="analAmznSelect" data-live-search="true">
                                        <option value="0" th:text="#{analyse.allAmznsSelect}">All Amazon Accounts</option>
                                    </select>
                                </div>
                                <div class="row mt-3">
                                    <div class="input-group-btn" data-toggle="buttons">
                                        <label class="btn btn-outline-info active">
                                            <input value="today" type="radio" name="dateFilter" id="option1" autocomplete="off" checked>
                                            Today
                                        </label>
                                        <label class="btn btn-outline-info">
                                            <input value="yesterday" type="radio" name="dateFilter" id="option2" autocomplete="off">
                                            Yesterday
                                        </label>
                                        <label class="btn btn-outline-info">
                                            <input value="thisMonth" type="radio" name="dateFilter" id="option3" autocomplete="off">
                                            This month
                                        </label>
                                        <label class="btn btn-outline-info">
                                            <input value="previousMonth" type="radio" name="dateFilter" id="option4" autocomplete="off">
                                            Previous month
                                        </label>
                                        <label class="btn btn-outline-info">
                                            <input value="custom" type="radio" name="dateFilter" id="option5" autocomplete="off">
                                            Custom
                                            <input type="text" name="dateRange" id="dateRange" autocomplete="off">
                                        </label>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <button id="btnAnalyse" class="btn btn-primary" type="button">ANALYSE SALES</button>
                                </div>
                                <div class="row mt-3">
                                    <div class="row" id="chartHolder" style="height:1000px; width:100%;">
                                        <!-- Chart Content -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <th:block th:replace="layout/footer :: footer"/>
        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<th:block th:replace="dashboard/temp/temp-option :: temp-option"/>
<th:block th:replace="layout/texts :: texts"/>
<th:block th:replace="layout/script :: script-dashboard"/>

<script>
    let page = {
        urls: {
            findAllGroups: CommonApp.BASE_URL_GROUP + "/findAllGroups",
            findAllAmzns: CommonApp.BASE_URL_AMZN_ACCOUNT + "/findAllAmznAccs",
            findAmznsInsideGroup: CommonApp.BASE_URL_GROUP + "/showAmznAccInsideGroup",
            getAnalyticsSale: CommonApp.BASE_URL_ANALYTICS
        },
        element: {},
        commands: {},
        dialogs: {
            element: {},
            alertDanger: {},
            inputError: {},
            messages: {}
        }
    }

    page.element.analGrpSelect = $('#analGrpSelect');
    page.element.analAmznSelect = $('#analAmznSelect');
    page.element.tempOption = $('#tempOption');
    page.element.dateRange = $('#dateRange');
    page.element.btnAnalyse = $('#btnAnalyse');

    let tempOption = $.validator.format($.trim(page.element.tempOption.val().toString()));

    page.commands.findAllGroups = () => {
        $.ajax({
            type: "GET",
            url: page.urls.findAllGroups
        })
            .done((groups) => {
                $.each(groups, (index, group) => {
                    page.commands.addGroupToSelect(group);
                });
                page.element.analGrpSelect.selectpicker('refresh');
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }

    page.commands.findAllAmzns = () => {
        $.ajax({
            type: "GET",
            url: page.urls.findAllAmzns
        })
            .done((amzns) => {
                page.commands.renderAmznOptions(amzns);
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }

    page.commands.findAmznInsideGroup = (groupId) => {
        if (groupId == 0) {
            page.element.analAmznSelect.find('[value!=0]').remove();
            page.commands.findAllAmzns();
            return;
        }
        $.ajax({
            type: "GET",
            url: page.urls.findAmznsInsideGroup + '/' + groupId
        })
            .done((amzns) => {
                if (amzns.length == 0) {
                    page.element.analAmznSelect.find('option').remove().end()
                        .append(`<option value="noAmzn" selected>${noAmzn}</option>`).val('noAmzn');
                    page.element.analAmznSelect.selectpicker('refresh');
                    return;
                }
                page.commands.renderAmznOptions(amzns);
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }

    page.commands.renderAmznOptions = (amzns) => {

        page.element.analAmznSelect.find('option').remove().end()
            .append(`<option value="0" selected>${allAmznsSelect}</option>`).val('0');

            $.each(amzns, (index, amzn) => {
                page.commands.addAmznToSelect(amzn);
            });

            page.element.analAmznSelect.selectpicker('refresh');

    }

    page.commands.addGroupToSelect = (group) => {
        page.element.analGrpSelect.append($(tempOption(group.id, group.title)));
    }

    page.commands.addAmznToSelect = (amzn) => {
        page.element.analAmznSelect.append($(tempOption(amzn.id, amzn.username)));
    }

    page.commands.handleAnalGrpSelect = () => {
        page.element.analGrpSelect.change(function () {
            let groupId = $(this).selectpicker('val');
            page.commands.findAmznInsideGroup(groupId);
        })
    }

    page.commands.handleBtnAnalyse = () => {
        let groupId = page.element.analGrpSelect.selectpicker('val');
        let amznId = page.element.analAmznSelect.selectpicker('val');
        let dateFilter = $('input[name=dateFilter]:checked').val();
        let analyticsParam = {
            groupId: {},
            amznId: {},
            dateFilter: {}
        }
        analyticsParam.groupId = groupId;
        analyticsParam.amznId = amznId;
        analyticsParam.dateFilter = dateFilter;

        page.commands.getChart(analyticsParam);
    }

    //Chart

    var options = {
        title: {
            text: "Revenues Dashboard",
            align: "center",
            style: {
                fontSize: '16px',
                fontWeight: "bold",
                color: "#41b2e6 "
            }
        },
        chart: {
            height: '300',
            type: "line",
            stacked: false,
            toolbar: {
                offsetX: -30,
                tools: {
                    download: '<img src="/assets/img/download-chart.png" width="20" height="20"/>',
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    reset: false,
                    pan: false
                },
                export: {
                    csv: {
                        filename: "Weekly Revenues"
                    },
                    svg: {
                        filename: "Weekly Revenues"
                    },
                    png: {
                        filename: "Weekly Revenues"
                    }
                }
            }
        },
        colors: ["#41b2e6", "#f9bd03"],
        series: [
            {
                name: "Royalties",
                type: "column",
                data: []
            },
            {
                name: "Sold",
                type: "line",
                data: []
            }
        ],
        xaxis: {
            categores: []
        },
        noData: {
            text: "Loading...",
        },
        yaxis: [
            {
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: "#41b2e6"
                },
                labels: {
                    formatter: function (value) {
                        return DBApp.fmtNumWMetricSuffix(value)
                    },
                    style: {
                        colors: "#41b2e6",
                        cssClass: "font-weight-bold"
                    }
                }
            },
            {
                opposite: true,
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: "#f9bd03"
                },
                labels: {
                    formatter: function (value) {
                        return DBApp.fmtNumWMetricSuffix(value)
                    },
                    style: {
                        colors: "#f9bd03",
                        cssClass: "font-weight-bold"
                    }
                }
            }
        ],
        stroke: {
            width: [2, 5]
        },
        plotOptions: {
            bar: {
                columnWidth: "70%"
            }
        },
        markers: {
            size: 5,
        },
        tooltip: {
            shared: false,
            intersect: true,
            x: {
                show: false
            }
        },
        grid: {
            padding: {
                left: -8,
                right: -8
            },
            yaxis: {
                lines: {
                    show: false
                }
            }
        },
        legend: {
            horizontalAlign: "center",
            offsetX: 0
        }
    };

    var chart = new ApexCharts($("#chartHolder")[0], options);

    chart.render();

    page.commands.getChart = (analyticsParam) => {
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: page.urls.getAnalyticsSale,
            data: JSON.stringify(analyticsParam)
        })
        .done((chartData) => {
            chart.updateOptions({
                xaxis: {
                    categories: chartData.dates
                },
                series: [
                    {
                        name: "Royalties",
                        data: chartData.royalties,
                    },
                    {
                        name: "Sold",
                        data: chartData.soldNumbers,
                    }
                ]
            });
        })
        .fail((jqXHR) => {
            DBApp.handleFailedTasks(jqXHR);
        })
    }

    $(document).ready(function () {
        DBApp.handleGroupsFilterSidebar();
        page.commands.findAllGroups();
        page.commands.findAllAmzns();
        page.commands.handleAnalGrpSelect();
        page.element.dateRange.daterangepicker();
        page.element.analGrpSelect.selectpicker('setStyle', 'btn-outline-primary');
        page.element.analAmznSelect.selectpicker('setStyle', 'btn-outline-primary');
        page.element.btnAnalyse.click(() => {
            page.commands.handleBtnAnalyse();
        })
    });

</script>
</body>
</html>