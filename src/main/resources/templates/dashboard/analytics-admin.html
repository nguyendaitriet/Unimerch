<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <th:block th:replace="layout/head :: dashboard-head"/>
    <title th:text="#{analyse.pageTitle}">Users Management</title>
</head>
<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <!-- Sidebar -->
    <th:block th:replace="layout/sidebar :: sidebar"/>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">

            <!-- Begin Page Content -->
            <div class="container-fluid mt-3">
                <div class="row">

                    <!-- Users -->
                    <div class="col">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <a class="m-0 h4 font-weight-bold text-primary text-decoration-none"
                                   th:text="#{analyse.tabHeader}">
                                </a>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="row">
                                            <select class="selectpicker" id="analGrpSelect" data-live-search="true">
                                                <option value="0" th:text="#{analyse.allGroupsSelect}">All Groups</option>
                                            </select>
                                            <select class="selectpicker ml-3" id="analAmznSelect" data-live-search="true">
                                                <option value="0" th:text="#{analyse.allAmznsSelect}">All Amazon Accounts
                                                </option>
                                            </select>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="input-group-btn" data-toggle="buttons">
                                                <label class="btn btn-outline-info active">
                                                    <input value="today" type="radio" name="dateFilter" id="option1"
                                                           autocomplete="off" checked>
                                                    Today
                                                </label>
                                                <label class="btn btn-outline-info">
                                                    <input value="yesterday" type="radio" name="dateFilter" id="option2"
                                                           autocomplete="off">
                                                    Yesterday
                                                </label>
                                                <label class="btn btn-outline-info">
                                                    <input value="thisMonth" type="radio" name="dateFilter" id="option3"
                                                           autocomplete="off">
                                                    This month
                                                </label>
                                                <label class="btn btn-outline-info">
                                                    <input value="previousMonth" type="radio" name="dateFilter" id="option4"
                                                           autocomplete="off">
                                                    Previous month
                                                </label>
                                                <label class="btn btn-outline-info">
                                                    <input value="custom" type="radio" name="dateFilter" id="customDateFilter"
                                                           autocomplete="off">
                                                    Custom
                                                </label>
                                                <input class="form-control" type="text" name="dateRange" id="dateRange"
                                                       autocomplete="off" hidden>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-2">Include Tag</div>
                                            <div id="tagGroupIncludeArea" class="col-md-10">

                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-2">Exclude Tag</div>
                                            <div id="tagGroupExcludeArea" class="col-md-10">

                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <button id="btnAnalyse" class="btn btn-primary text-uppercase" type="button"
                                                    th:text="#{analyse.btn.analyseSale}">ANALYSE SALES
                                            </button>
                                            <button type="button" class="btn btn-secondary ml-3" id="btnResetProductFilter"
                                                    th:text="#{analyse.btn.reset}">Reset
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-left-primary shadow">
                                            <div class="card-body">
                                                <div class="row no-gutters align-items-center mb-2">
                                                    <div class="col mr-2">
                                                        <div class="text-center font-weight-bold text-primary text-uppercase">
                                                            Today's Sale
                                                            <br>
                                                            <span id="todayDate"></span>
                                                        </div>

                                                        <hr class="sidebar-divider my-2">

                                                        <div id="todayPurchased"
                                                             class="h2 text-center mb-0 font-weight-bold text-gray-800">
                                                            0
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row mt-1 no-gutters d-flex justify-content-between">
                                                    <div id="todayRoyalties">
                                                        0
                                                    </div>
                                                    <div>
                                                        Royalties
                                                    </div>
                                                </div>
                                                <div class="row mt-1 no-gutters d-flex justify-content-between">
                                                    <div>
                                                        <span id="todaySold">0</span> - <span
                                                            id="todayCancelled">0</span>
                                                    </div>
                                                    <div>
                                                        Sold-Cancelled
                                                    </div>
                                                </div>
                                                <div class="row mt-1 no-gutters d-flex justify-content-between">
                                                    <div id="todayReturned">
                                                        0
                                                    </div>
                                                    <div>
                                                        Returned
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="sidebar-divider">

                                <div class="row mt-3">
                                    <div class="input-group-btn" data-toggle="buttons">
                                        <label class="btn btn-light active">
                                            <input id="dailyChartRadio" value="daily" type="radio" name="dailyOrMonthly"
                                                   autocomplete="off" checked>
                                            Daily
                                        </label>
                                        <label class="btn btn-light">
                                            <input id="monthlyChartRadio" value="monthly" type="radio"
                                                   name="dailyOrMonthly" autocomplete="off">
                                            Monthly
                                        </label>
                                    </div>
                                </div>
                                <div class="row mt-3" id="chartHolder" style="width:100%;">
                                    <!-- Chart Content -->
                                </div>

                                <hr class="sidebar-divider">

                                <div class="mt-3 mb-3 row">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control bg-light border-0 small"
                                                   placeholder="Search for asin or title" aria-label="Search"
                                                   aria-describedby="basic-addon2">
                                            <div class="input-group-append">
                                                <button class="btn btn-primary" type="button">
                                                    <i class="fas fa-search fa-sm"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8" id="tagGroupLegend">

                                    </div>
                                    </div>
                                <div class="row mt-3">
                                    <div class="table-responsive" style="width: 80%">
                                        <table class="table table-bordered table-sm" id="tableProductAnalytics">
                                            <thead>
                                            <tr class="text-center">
                                                <th>Sold</th>
                                                <th>Product</th>
                                                <th>Royalties</th>
                                                <th>Price</th>
                                                <th>Username</th>
                                            </tr>
                                            </thead>

                                            <tbody>

                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <th:block th:replace="layout/footer :: footer"/>
        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<th:block th:replace="dashboard/temp/temp-option :: temp-option"/>
<th:block th:replace="dashboard/temp/temp-option :: temp-tagGroup-select"/>
<th:block th:replace="dashboard/temp/temp-table-product-analytics :: temp-table-product-analytics"/>
<th:block th:replace="dashboard/temp/temp-table-product-analytics :: temp-product-tagGroup"/>
<th:block th:replace="dashboard/temp/temp-table-product-analytics :: temp-tagGroup-legend"/>
<th:block th:replace="layout/texts :: texts"/>
<th:block th:replace="layout/script :: script-dashboard"/>

<script>
    let page = {
        urls: {
            findAllGroups: CommonApp.BASE_URL_GROUP + "/findAllGroups",
            findAllAmzns: CommonApp.BASE_URL_AMZN_ACCOUNT + "/findAllAmznAccs",
            findAmznsInsideGroup: CommonApp.BASE_URL_GROUP + "/showAmznAccInsideGroup",
            getAnalyticsSale: CommonApp.BASE_URL_ANALYTICS,
            getProductAnalytics: CommonApp.BASE_URL_ANALYTICS + "/getProductAnalytics",
            findAllTagGroupsAndTagsInside: CommonApp.BASE_URL_TAG + "/findAllTagGroupsAndTagsInside"
        },
        element: {},
        commands: {},
        dialogs: {
            element: {},
            alertDanger: {},
            inputError: {},
            messages: {}
        }
    }

    page.element.analGrpSelect = $('#analGrpSelect');
    page.element.analAmznSelect = $('#analAmznSelect');
    page.element.tempOption = $('#tempOption');
    page.element.tempTagGroupSelect = $('#tempTagGroupSelect');
    page.element.tempTagGroupLegend = $('#tempTagGroupLegend');
    page.element.tagGroupIncludeArea = $('#tagGroupIncludeArea');
    page.element.tagGroupExcludeArea = $('#tagGroupExcludeArea');
    page.element.tagGroupLegendArea = $('#tagGroupLegend');
    page.element.dateRange = $('#dateRange');
    page.element.btnAnalyse = $('#btnAnalyse');
    page.element.customDateFilter = $('#customDateFilter');
    page.element.dateRange = $('#dateRange');
    page.element.dailyChartRadio = $('#dailyChartRadio');
    page.element.monthlyChartRadio = $('#monthlyChartRadio');

    let tempOption = $.validator.format($.trim(page.element.tempOption.val().toString()));
    let tempTagGroupSelect = $.validator.format($.trim(page.element.tempTagGroupSelect.val().toString()));
    let tempTagGroupLegend = $.validator.format($.trim(page.element.tempTagGroupLegend.val().toString()));

    page.commands.findAllGroups = () => {
        $.ajax({
            type: "GET",
            url: page.urls.findAllGroups
        })
            .done((groups) => {
                $.each(groups, (index, group) => {
                    page.commands.addGroupToSelect(group);
                });
                page.element.analGrpSelect.selectpicker('refresh');
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }
    page.commands.findAllAmzns = () => {
        $.ajax({
            type: "GET",
            url: page.urls.findAllAmzns
        })
            .done((amzns) => {
                page.commands.renderAmznOptions(amzns);
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }
    page.commands.findAmznInsideGroup = (groupId) => {
        if (groupId == 0) {
            page.element.analAmznSelect.find('[value!=0]').remove();
            page.commands.findAllAmzns();
            return;
        }
        $.ajax({
            type: "GET",
            url: page.urls.findAmznsInsideGroup + '/' + groupId
        })
            .done((amzns) => {
                if (amzns.length == 0) {
                    page.element.analAmznSelect.find('option').remove().end()
                        .append(`<option value='noAmzn' selected>${noAmzn}</option>`).val('noAmzn');
                    page.element.analAmznSelect.selectpicker('refresh');
                    return;
                }
                page.commands.renderAmznOptions(amzns);
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }
    page.commands.renderAmznOptions = (amzns) => {

        page.element.analAmznSelect.find('option').remove().end()
            .append(`<option value="0" selected>${allAmznsSelect}</option>`).val('0');

        $.each(amzns, (index, amzn) => {
            page.commands.addAmznToSelect(amzn);
        });

        page.element.analAmznSelect.selectpicker('refresh');

    }
    page.commands.addGroupToSelect = (group) => {
        page.element.analGrpSelect.append($(tempOption(group.id, group.title)));
    }
    page.commands.addAmznToSelect = (amzn) => {
        page.element.analAmznSelect.append($(tempOption(amzn.id, amzn.username)));
    }

    page.commands.handleAnalGrpSelect = () => {
        page.element.analGrpSelect.change(function () {
            let groupId = $(this).selectpicker('val');
            page.commands.findAmznInsideGroup(groupId);
        })
    }
    page.commands.handleBtnAnalyse = () => {
        let groupId = page.element.analGrpSelect.selectpicker('val');
        let amznId = page.element.analAmznSelect.selectpicker('val');
        let dateFilter = $('input[name=dateFilter]:checked').val();
        let starDate = page.element.dateRange.data('daterangepicker').startDate.format('DD/MM/YYYY');
        let endDate = page.element.dateRange.data('daterangepicker').endDate.format('DD/MM/YYYY');
        let analyticsParam = new AnalyticsParam(groupId, amznId, dateFilter, starDate, endDate);

        if(groupId != 0 && amznId == 'noAmzn') {
            CommonApp.IziToast.showErrorAlert(noAmznVi);
            return;
        }

        page.commands.getChart(analyticsParam);
        page.commands.getProductAnalytics(analyticsParam);
    }
    page.commands.handleCustomDateRange = () => {
        $('input[type=radio][name=dateFilter]').change(function () {
            if (this.value === 'custom') {
                page.element.dateRange.attr('hidden', false);
            } else {
                page.element.dateRange.attr('hidden', true);
            }
        });
    }
    page.commands.handleDailyOrMonthLyChart = () => {
        $('input[type=radio][name=dailyOrMonthly]').change(function () {
            if (this.value === 'daily') {
                chart.updateOptions({
                    xaxis: {
                        categories: dataOfChart.dates
                    },
                    series: [
                        {
                            name: "Royalties",
                            data: dataOfChart.royalties,
                        },
                        {
                            name: "Sold",
                            data: dataOfChart.soldNumbers,
                        }
                    ]
                });
            } else {
                let monthlyOrderChartResult = page.commands.handleMonthlyChartData(dataOfChart);
                chart.updateOptions({
                    xaxis: {
                        categories: monthlyOrderChartResult.monthList
                    },
                    series: [
                        {
                            name: "Royalties",
                            data: monthlyOrderChartResult.royaltiesList,
                        },
                        {
                            name: "Sold",
                            data: monthlyOrderChartResult.soldNumbersList,
                        }
                    ]
                });
            }
        });
    }
    page.commands.handleMonthlyChartData = (data) => {
        let dailyRevenueArray = [];
        let dateCount = data.dates.length;
        for (let i = 0; i < dateCount; i++) {
            let dailyRevenue = new DailyRevenue(data.dates[i], data.royalties[i], data.soldNumbers[i]);
            dailyRevenueArray.push(dailyRevenue);
        }

        let monthGroup = CommonApp.groupBy(dailyRevenueArray, dailyRevenue => dailyRevenue.date.substring(3));

        let monthTitle = [];
        let royaltiesSum = [];
        let soldNumbersSum = [];

        monthGroup.forEach(function(value, key) {
            monthTitle.push(key);
            let royalties = 0;
            let soldNumbers = 0;
            value.forEach((item, index) => {
                royalties += item.royalties;
                soldNumbers += item.soldNumbers;
            })
            let roundedRoyalties = Math.round((royalties + Number.EPSILON) * 100) / 100;
            royaltiesSum.push(roundedRoyalties);
            soldNumbersSum.push(soldNumbers);
        })

        return new MonthlyOrderChartResult(monthTitle, royaltiesSum, soldNumbersSum);
    }

    page.commands.findAllTagGroupsAndTagsInside = () => {
        $.ajax({
            type: "GET",
            url: page.urls.findAllTagGroupsAndTagsInside
        })
            .done((fullTagGroupsTagResultList) => {

                $.each(fullTagGroupsTagResultList, (index, element) => {
                    page.commands.addTagGroupToFilterArea(element.tagGroup);
                    page.commands.addTagGroupToTagGroupLegend(element.tagGroup);
                    let tagGroupId = element.tagGroup.id;
                    $.each(element.tagResultList, (index, tagResult) => {
                        page.commands.addTagOptionToTagGroupSelect(tagGroupId, tagResult);
                    })
                });
                // var tagGroupSelect = new Choices('.tag-group-select');
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }

    page.commands.addTagGroupToFilterArea = (tagGroup) => {
        page.element.tagGroupIncludeArea.append($(tempTagGroupSelect(tagGroup.id, tagGroup.name, tagGroup.color)));
        page.element.tagGroupExcludeArea.append($(tempTagGroupSelect(tagGroup.id, tagGroup.name, tagGroup.color)));
    }
    page.commands.addTagGroupToTagGroupLegend = (tagGroup) => {
        page.element.tagGroupLegendArea.append($(tempTagGroupLegend(tagGroup.name, tagGroup.color)));
    }
    page.commands.addTagOptionToTagGroupSelect = (tagGroupId, tagResult) => {
        $(`.tag-group-select-id-${tagGroupId}`).append($(tempOption(tagResult.id, tagResult.name)))
    }

    //Analytics Sales Chart

    var options = {
        title: {
            text: "Revenues Dashboard",
            align: "center",
            style: {
                fontSize: '25px',
                fontWeight: "bold",
                color: "#41b2e6 "
            }
        },
        chart: {
            height: '400',
            type: "line",
            stacked: false,
            toolbar: {
                offsetX: -30,
                tools: {
                    download: '<img src="/assets/img/download-chart.png" width="20" height="20"/>',
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    reset: false,
                    pan: false
                },
                export: {
                    csv: {
                        filename: "Weekly Revenues"
                    },
                    svg: {
                        filename: "Weekly Revenues"
                    },
                    png: {
                        filename: "Weekly Revenues"
                    }
                }
            }
        },
        colors: ["#41b2e6", "#f9bd03"],
        series: [
            {
                name: "Royalties",
                type: "column",
                data: []
            },
            {
                name: "Sold",
                type: "line",
                data: []
            }
        ],
        xaxis: {
            categores: []
        },
        noData: {
            text: "Loading...",
        },
        yaxis: [
            {
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: "#41b2e6"
                },
                labels: {
                    formatter: function (value) {
                        return DBApp.fmtNumWMetricSuffix(value)
                    },
                    style: {
                        colors: "#41b2e6",
                        cssClass: "font-weight-bold"
                    }
                }
            },
            {
                opposite: true,
                axisTicks: {
                    show: true
                },
                axisBorder: {
                    show: true,
                    color: "#f9bd03"
                },
                labels: {
                    formatter: function (value) {
                        return DBApp.fmtNumWMetricSuffix(value)
                    },
                    style: {
                        colors: "#f9bd03",
                        cssClass: "font-weight-bold"
                    }
                }
            }
        ],
        stroke: {
            width: [2, 5]
        },
        plotOptions: {
            bar: {
                columnWidth: '70%'
            }
        },
        markers: {
            size: 5,
        },
        tooltip: {
            shared: false,
            intersect: true,
            x: {
                show: false
            }
        },
        grid: {
            padding: {
                left: -5,
                right: -5
            },
            yaxis: {
                lines: {
                    show: false
                }
            }
        },
        legend: {
            horizontalAlign: "center",
            offsetX: 0
        }
    };

    var chart = new ApexCharts($("#chartHolder")[0], options);

    chart.render();

    var dataOfChart;

    page.commands.getChart = (analyticsParam) => {
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: page.urls.getAnalyticsSale,
            data: JSON.stringify(analyticsParam)
        })
            .done((chartData) => {
                dataOfChart = chartData;
                let titleChartUpdate;
                let datesLength = chartData.dates.length;
                if (datesLength === 1) {
                    titleChartUpdate = `Revenues Dashboard ${chartData.dates[0]}`;
                } else {
                    titleChartUpdate = `Revenues Dashboard ${chartData.dates[0]} - ${chartData.dates[datesLength - 1]}`;
                }

                chart.updateOptions({
                    title: {
                        text: titleChartUpdate,
                    },
                    xaxis: {
                        categories: chartData.dates
                    },
                    series: [
                        {
                            name: "Royalties",
                            data: chartData.royalties,
                        },
                        {
                            name: "Sold",
                            data: chartData.soldNumbers,
                        }
                    ]
                });

                page.element.dailyChartRadio.prop('checked', true);
                page.element.dailyChartRadio.parent().addClass('active');
                page.element.monthlyChartRadio.parent().removeClass('active');
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }

    // Analytics Sales Table
    page.element.tableProductAnalyticsBody = $('#tableProductAnalytics tbody');
    page.element.tempTableProductAnalytics = $('#tempTableProductAnalytics');
    page.element.tempProductTag = $('#tempProductTag');

    page.element.productAnalDateRange = $('#productAnalDateRange')
    page.element.btnAnalyseProductFilter = $('#btnAnalyseProductFilter');
    page.element.btnResetProductFilter = $('#btnResetProductFilter');

    let tempTableProductAnalytics = $.validator.format($.trim(page.element.tempTableProductAnalytics.val().toString()));
    let tempProductTag = $.validator.format($.trim(page.element.tempProductTag.val().toString()));

    page.commands.getProductAnalytics = (analyticsParam) => {
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: page.urls.getProductAnalytics,
            data: JSON.stringify(analyticsParam)
        })
            .done((productAnalyticsList) => {
                page.element.tableProductAnalyticsBody.html('');

                $.each(productAnalyticsList, (index, item) => {
                    page.commands.addProductAnalyticsToTable(item.productResult);

                    let tdId = `${item.productResult.asin}-${item.productResult.amznAccUsername}`;
                    $.each(item.tagGroupTagResultList, (index, item) => {
                        page.commands.addTagToProductTable(tdId, item);
                    })
                })
            })
            .fail((jqXHR) => {
                DBApp.handleFailedTasks(jqXHR);
            })
    }
    page.commands.addProductAnalyticsToTable = (productAnalytics) => {
        let shortProductName = CommonApp.clipText(productAnalytics.productName, 20)
        page.element.tableProductAnalyticsBody.append($(tempTableProductAnalytics(productAnalytics.asin,
            shortProductName, productAnalytics.quantitySold, productAnalytics.royalties,
            productAnalytics.price, productAnalytics.amznAccUsername)));
    }
    page.commands.addTagToProductTable = (tdId, tagGroupTagResult) => {
        $(`#${tdId}`).prepend($(tempProductTag(tagGroupTagResult.tagGroupId, tagGroupTagResult.tagName, tagGroupTagResult.tagGroupColor)))
    }

    $(document).ready(function () {
        DBApp.handleGroupsFilterSidebar();
        page.commands.findAllGroups();
        page.commands.findAllAmzns();
        page.commands.findAllTagGroupsAndTagsInside();
        page.commands.handleAnalGrpSelect();
        page.commands.handleCustomDateRange();
        page.commands.handleDailyOrMonthLyChart();
        page.element.dateRange.daterangepicker({
            locale: {
                format: "DD/MM/YYYY"
            }
        });
        page.element.analGrpSelect.selectpicker('setStyle', 'btn-outline-primary');
        page.element.analAmznSelect.selectpicker('setStyle', 'btn-outline-primary');
        page.element.btnAnalyse.click(() => {
            page.commands.handleBtnAnalyse();
        })
        page.element.productAnalDateRange.daterangepicker({
            locale: {
                format: "DD/MM/YYYY"
            }
        });
    });

</script>
</body>
</html>